name: Sync Docker Hub Descriptions

on:
  # Ejecutar cuando hay cambios en READMEs de componentes
  push:
    branches:
      - main
    paths:
      - 'components/**/README.md'
  
  # Permitir ejecución manual
  workflow_dispatch:

jobs:
  # Primero detectamos qué componentes han cambiado
  detect-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed READMEs and build matrix
        id: set-matrix
        run: |
          set -e
          
          echo ">> Detecting changed README files..."
          
          # Detectar archivos cambiados
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          else
            # En workflow_dispatch, sincronizar todos los componentes
            CHANGED_FILES=""
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          COMPONENTS=()
          
          if [ -z "$CHANGED_FILES" ]; then
            # Manual trigger - sincronizar todos los componentes
            echo ">> Manual trigger - will sync all components"
            for component_dir in components/*/; do
              if [ -d "$component_dir" ]; then
                component=$(basename "$component_dir")
                if [ -f "components/${component}/README.md" ]; then
                  COMPONENTS+=("$component")
                fi
              fi
            done
          else
            # Extraer componentes con README.md modificados
            for file in $CHANGED_FILES; do
              if [[ "$file" =~ ^components/([^/]+)/README\.md$ ]]; then
                component="${BASH_REMATCH[1]}"
                COMPONENTS+=("$component")
                echo ">> Detected change in component: $component"
              fi
            done
          fi
          
          # Construir matriz JSON
          if [ ${#COMPONENTS[@]} -eq 0 ]; then
            echo ">> No components to sync"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"component\":[]}" >> $GITHUB_OUTPUT
          else
            # Crear JSON array
            JSON_ARRAY=$(printf '%s\n' "${COMPONENTS[@]}" | jq -R . | jq -s -c .)
            echo "matrix={\"component\":$JSON_ARRAY}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ">> Components to sync: ${COMPONENTS[*]}"
          fi

  # Job que sincroniza cada componente usando la acción oficial
  sync-descriptions:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync ${{ matrix.component }} description to Docker Hub
        uses: peter-evans/dockerhub-description@v4
        with:
          username: toolkitbox
          password: ${{ secrets.DOCKER_TOKEN }}
          repository: toolkitbox/${{ matrix.component }}
          readme-filepath: components/${{ matrix.component }}/README.md
          short-description: "DevOps toolkit - ${{ matrix.component }} client"
