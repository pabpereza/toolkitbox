name: Sync Docker Hub Descriptions

on:
  # Ejecutar cuando hay cambios en READMEs de componentes o en el README principal
  push:
    branches:
      - main
    paths:
      - 'components/**/README.md'
      - 'README.md'
  
  # Permitir ejecución manual
  workflow_dispatch:

jobs:
  # Primero detectamos qué componentes han cambiado
  detect-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
      sync_all_image: ${{ steps.set-matrix.outputs.sync_all_image }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed READMEs and build matrix
        id: set-matrix
        run: |
          set -e
          
          echo ">> Detecting changed README files..."
          
          # Detectar archivos cambiados
          if [ "${{ github.event_name }}" == "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || git diff --name-only HEAD~1 HEAD)
          else
            # En workflow_dispatch, sincronizar todos los componentes
            CHANGED_FILES=""
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          COMPONENTS=()
          SYNC_ALL_IMAGE="false"
          
          if [ -z "$CHANGED_FILES" ]; then
            # Manual trigger - sincronizar todos los componentes + imagen all
            echo ">> Manual trigger - will sync all components and 'all' image"
            SYNC_ALL_IMAGE="true"
            for component_dir in components/*/; do
              if [ -d "$component_dir" ]; then
                component=$(basename "$component_dir")
                if [ -f "components/${component}/README.md" ]; then
                  COMPONENTS+=("$component")
                fi
              fi
            done
          else
            # Verificar si el README.md de la raíz ha cambiado
            if echo "$CHANGED_FILES" | grep -q "^README\.md$"; then
              echo ">> Detected change in root README.md - will sync 'all' image"
              SYNC_ALL_IMAGE="true"
            fi
            
            # Extraer componentes con README.md modificados
            for file in $CHANGED_FILES; do
              if [[ "$file" =~ ^components/([^/]+)/README\.md$ ]]; then
                component="${BASH_REMATCH[1]}"
                COMPONENTS+=("$component")
                echo ">> Detected change in component: $component"
              fi
            done
          fi
          
          # Guardar si hay que sincronizar la imagen 'all'
          echo "sync_all_image=$SYNC_ALL_IMAGE" >> $GITHUB_OUTPUT
          
          # Construir matriz JSON
          if [ ${#COMPONENTS[@]} -eq 0 ]; then
            echo ">> No components to sync"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"component\":[]}" >> $GITHUB_OUTPUT
          else
            # Crear JSON array
            JSON_ARRAY=$(printf '%s\n' "${COMPONENTS[@]}" | jq -R . | jq -s -c .)
            echo "matrix={\"component\":$JSON_ARRAY}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ">> Components to sync: ${COMPONENTS[*]}"
          fi

  # Job que sincroniza cada componente usando la acción oficial
  sync-components:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync ${{ matrix.component }} description to Docker Hub
        uses: peter-evans/dockerhub-description@v4
        with:
          username: toolkitbox
          password: ${{ secrets.DOCKER_TOKEN }}
          repository: toolkitbox/${{ matrix.component }}
          readme-filepath: components/${{ matrix.component }}/README.md
          short-description: "DevOps toolkit - ${{ matrix.component }} client"

  # Job que sincroniza la imagen 'all' (bundle con todas las herramientas)
  sync-all-image:
    needs: detect-changes
    if: needs.detect-changes.outputs.sync_all_image == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sync 'all' bundle description to Docker Hub
        uses: peter-evans/dockerhub-description@v4
        with:
          username: toolkitbox
          password: ${{ secrets.DOCKER_TOKEN }}
          repository: toolkitbox/all
          readme-filepath: README.md
          short-description: "DevOps toolkit - All-in-one bundle with multiple CLI tools"
